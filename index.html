<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Magenta • Microknots — Chat UI Packetizer</title>

<!-- libs -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  :root{
    --bg:#f7f7f8;         /* ChatGPT light */
    --pane:#ffffff;
    --ink:#0b0b0c;
    --muted:#6b6f76;
    --line:#e5e7eb;
    --hl:#10a37f;         /* subtle green accent */
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
    color:var(--ink);
    background:var(--bg);
  }
  .app{
    display:grid;
    grid-template-columns: 260px 1fr;
    min-height:100vh;
  }
  /* Sidebar (ChatGPT-ish) */
  aside{
    background:#fafafa;
    border-right:1px solid var(--line);
    display:flex; flex-direction:column; gap:14px; padding:14px;
  }
  .brand{
    display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px;
    background:#fff; border:1px solid var(--line);
  }
  .brand img{height:32px; width:auto; border-radius:8px}
  .brand h1{font-size:15px; margin:0}
  .nav-btn{
    appearance:none; border:1px dashed #d7d9df; background:#fff; color:#111;
    border-radius:12px; padding:10px 12px; text-align:left; cursor:pointer;
  }
  .credits{
    margin-top:auto; font-size:12px; color:var(--muted); padding:0 4px 6px 4px;
  }

  /* Main pane */
  main{display:flex; flex-direction:column; height:100vh}
  header.top{
    border-bottom:1px solid var(--line);
    background:#fff;
    padding:14px 18px;
    display:flex; align-items:center; gap:12px;
    position:sticky; top:0; z-index:10;
  }
  .upload{
    flex:1; display:flex; align-items:center; gap:10px;
    border:1.5px dashed #cfd3da; background:#fff; padding:10px 12px; border-radius:14px;
  }
  .upload input{display:none}
  .upload .hint{color:var(--muted); font-size:13px}
  .btn{
    appearance:none; border:none; background:var(--hl); color:#fff; padding:10px 14px;
    border-radius:12px; font-weight:700; cursor:pointer;
  }
  .btn.ghost{background:#fff; color:#111; border:1px solid var(--line)}
  .select{
    border:1px solid var(--line); background:#fff; border-radius:12px; padding:8px 10px; font-weight:600;
  }

  /* Chat feed */
  .feed{
    flex:1; overflow:auto; padding:24px; display:flex; flex-direction:column; gap:16px;
  }
  .msg{
    display:flex; gap:12px; align-items:flex-start;
  }
  .msg .avatar{
    width:28px; height:28px; border-radius:8px; background:#111; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; font-size:12px;
  }
  .msg.user .avatar{background:#e5e7eb; color:#111}
  .bubble{
    background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px 14px; max-width:900px;
    box-shadow: 0 2px 0 rgba(0,0,0,0.02);
  }
  .bubble h4{margin:0 0 8px; font-size:14px}
  .bubble .tiny{color:var(--muted); font-size:12px}
  .code{
    background:#0f172a; color:#e6eaf5; border-radius:12px; padding:10px 12px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;
  }
  .row{display:flex; gap:10px; flex-wrap:wrap}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{border-bottom:1px solid var(--line); padding:7px 6px; text-align:left}

  footer.input{
    border-top:1px solid var(--line); background:#fff; padding:14px 18px;
    display:flex; gap:10px; align-items:center;
  }
  .pill{font-size:12px; color:var(--muted)}

  .drop-active{outline:2px solid var(--hl); outline-offset:2px}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside>
    <div class="brand">
      <img src="microknots-logo.png" alt="microknots" onerror="this.style.display='none'">
      <div>
        <h1>Magenta Packetizer</h1>
        <div style="font-size:12px;color:var(--muted)">Microknots</div>
      </div>
    </div>

    <button class="nav-btn" id="newSession">➕ New Session</button>
    <button class="nav-btn" id="downloadJsonl" disabled>⬇️ Download JSONL</button>
    <button class="nav-btn" id="downloadZip" disabled>⬇️ Download ZIP (JSONL+manifest)</button>

    <div class="credits">Made in a ChatGPT-style UI. <br>© Microknots • <strong>by Monish Allada</strong></div>
  </aside>

  <!-- Main -->
  <main>
    <header class="top">
      <div id="drop" class="upload" tabindex="0">
        <label for="file" class="btn ghost">Choose file</label>
        <input id="file" type="file" accept=".csv,.xlsx,.xls,.json" />
        <div class="hint">or drag & drop CSV / XLSX / JSON here. We process locally.</div>
      </div>
      <select id="packetType" class="select" title="packet type">
        <option value="classification">Classification (text + label)</option>
        <option value="chat">Chat/Instruction (input → expected_output)</option>
        <option value="rag">RAG Chunk (content + source)</option>
      </select>
    </header>

    <section id="feed" class="feed">
      <div class="msg">
        <div class="avatar">M</div>
        <div class="bubble">
          <h4>Welcome to Magenta</h4>
          Drop a file above and I’ll turn it into LLM-ready <b>JSONL</b>. You’ll get a preview and download buttons.
          <div class="tiny" style="margin-top:8px">Supports: CSV, XLSX, JSON • All processing is in your browser.</div>
        </div>
      </div>
    </section>

    <footer class="input">
      <span class="pill">Tip: name your logo file <code style="background:#f1f5f9;padding:2px 4px;border-radius:6px">microknots-logo.png</code> to show it in the sidebar.</span>
    </footer>
  </main>
</div>

<script>
/* ====== Simple Chat helpers ====== */
const feed = document.getElementById('feed');
function addMsg(role, html){
  const msg = document.createElement('div'); msg.className = 'msg ' + (role==='user'?'user':'assistant');
  msg.innerHTML = `
    <div class="avatar">${role==='user'?'U':'M'}</div>
    <div class="bubble">${html}</div>
  `;
  feed.appendChild(msg);
  feed.scrollTop = feed.scrollHeight;
  return msg.querySelector('.bubble');
}
function addCodeBlock(parent, text){
  const pre = document.createElement('pre'); pre.className = 'code'; pre.textContent = text; parent.appendChild(pre);
}
function addTable(parent, rows, cols){
  const t = document.createElement('table');
  t.innerHTML = `<thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr></thead>
                 <tbody>${rows.map(r=>`<tr>${cols.map(c=>`<td>${escapeHtml(String(r[c] ?? '')).slice(0,140)}</td>`).join('')}</tr>`).join('')}</tbody>`;
  parent.appendChild(t);
}
const escapeHtml = (s)=> s.replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));

/* ====== Parsing / Transform ====== */
let rawRows=[], columns=[], packetType='classification', builtRows=[];
const pktSel = document.getElementById('packetType');
pktSel.addEventListener('change', ()=>{ packetType = pktSel.value; if(rawRows.length){ processAndShow(); }});

async function parseFile(file){
  const name = file.name.toLowerCase();
  if(name.endsWith('.csv')){
    return new Promise((res)=>{
      Papa.parse(file, {header:true, dynamicTyping:false, skipEmptyLines:true,
        complete: (r)=> res(r.data)
      });
    });
  }
  if(name.endsWith('.xlsx') || name.endsWith('.xls')){
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws, {defval:''});
  }
  if(name.endsWith('.json')){
    const txt = await file.text();
    const data = JSON.parse(txt);
    return Array.isArray(data)? data : data.data || [];
  }
  throw new Error('Unsupported file type.');
}

function guessMapping(cols, type){
  const lc = cols.map(c=>[c,c.toLowerCase()]);
  const find = (keys)=> lc.find(([c,l])=> keys.some(k=> l.includes(k)))?.[0];
  if(type==='classification') return {
    text:  find(['text','content','message','review','body','comment','description']) || cols[0],
    label: find(['label','class','category','intent','tag']),
    id:    find(['id','uuid','guid','key']) || null
  };
  if(type==='chat') return {
    input:  find(['input','question','prompt','query','source']) || cols[0],
    output: find(['output','answer','response','completion','target']),
    id:     find(['id','uuid','guid','key']) || null
  };
  if(type==='rag') return {
    text:   find(['text','content','body','article','document','chunk']) || cols[0],
    source: find(['source','url','path','doc','file']) || null,
    id:     find(['id','uuid','guid','key']) || null
  };
  return {};
}

function applyQuality(s){
  if(typeof s!=='string') s = String(s ?? '');
  s = s.replace(/<[^>]+>/g,' ');         // strip HTML
  s = s.replace(/\s+/g,' ').trim();      // collapse WS
  // basic PII mask
  s = s.replace(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi,'<EMAIL>')
       .replace(/\b\d{3}-?\d{2}-?\d{4}\b/g,'<SSN>')
       .replace(/\b(?:\d[ -]*?){13,19}\b/g,'<CARD>');
  return s;
}

function chunkText(str, size=900, overlap=120){
  const out=[]; let i=0, idx=1; while(i<str.length){ const end=Math.min(str.length, i+size); out.push({idx, text:str.slice(i,end)}); idx++; i = end - overlap; if(i<=0) i=end; }
  return out;
}

function assemble(rows, map, type){
  if(type==='classification'){
    let arr = rows.map((r,i)=>({
      id: r[map.id] ?? (i+1),
      text: applyQuality(r[map.text] ?? ''),
      label: r[map.label] ?? null,
      _meta: Object.fromEntries(Object.keys(r).filter(k=> !Object.values(map).includes(k)).map(k=>[k,r[k]]))
    }));
    // dedupe by text
    const seen=new Set(); arr = arr.filter(x=>{ const k=x.text; if(seen.has(k)) return false; seen.add(k); return true;});
    return arr;
  }
  if(type==='chat'){
    let arr = rows.map((r,i)=>({
      id: r[map.id] ?? (i+1),
      input: applyQuality(r[map.input] ?? ''),
      expected_output: applyQuality(r[map.output] ?? ''),
      _meta: Object.fromEntries(Object.keys(r).filter(k=> !Object.values(map).includes(k)).map(k=>[k,r[k]]))
    }));
    const seen=new Set(); arr = arr.filter(x=>{ const k=x.input+'→'+x.expected_output; if(seen.has(k)) return false; seen.add(k); return true;});
    return arr;
  }
  if(type==='rag'){
    const out=[];
    rows.forEach((r,i)=>{
      const baseId = r[map.id] ?? (i+1);
      const text = applyQuality(r[map.text] ?? '');
      const src  = r[map.source] ?? ('row:'+ (i+1));
      for(const piece of chunkText(text)){
        out.push({
          id: baseId+':'+piece.idx,
          content: piece.text,
          source: src,
          _meta: Object.fromEntries(Object.keys(r).filter(k=> !Object.values(map).includes(k)).map(k=>[k,r[k]]))
        });
      }
    });
    const seen=new Set(); return out.filter(x=>{ if(seen.has(x.content)) return false; seen.add(x.content); return true;});
  }
  return [];
}

function toJSONL(arr){ return arr.map(o=>JSON.stringify(o)).join('\n'); }

/* ====== ZIP bundle ====== */
function schemaFor(type){
  if(type==='classification'){
    return {type:'jsonl', item:{required:['id','text'], optional:['label','_meta']}};
  } else if(type==='chat'){
    return {type:'jsonl', item:{required:['id','input','expected_output'], optional:['_meta']}};
  } else {
    return {type:'jsonl', item:{required:['id','content','source'], optional:['_meta']}};
  }
}
async function makeZip(jsonl, type, map, rowsCount){
  const zip = new JSZip();
  zip.file('data.jsonl', jsonl);
  zip.file('schema.json', JSON.stringify(schemaFor(type), null, 2));
  zip.file('manifest.json', JSON.stringify({
    name:'magenta-packet',
    packet_type:type,
    created_at:new Date().toISOString(),
    rows:rowsCount,
    roles:map
  }, null, 2));
  zip.file('README.md', `# Magenta Data Packet

Type: **${type}**
Rows: **${rowsCount}**

## Roles
${Object.entries(map).map(([k,v])=>`- ${k}: \`${v}\``).join('\n')}
`);
  return await zip.generateAsync({type:'blob'});
}

/* ====== Upload handling (ChatGPT-like top bar) ====== */
const fileInput = document.getElementById('file');
const dropArea = document.getElementById('drop');
['dragenter','dragover'].forEach(evt=> dropArea.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropArea.classList.add('drop-active'); }));
['dragleave','drop'].forEach(evt=> dropArea.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drop-active'); }));
dropArea.addEventListener('drop', e=>{ const f = e.dataTransfer.files[0]; if(f) handleFile(f); });
fileInput.addEventListener('change', ()=>{ const f=fileInput.files[0]; if(f) handleFile(f); });

document.getElementById('newSession').addEventListener('click', ()=>{
  rawRows=[]; columns=[]; builtRows=[]; feed.innerHTML=''; addMsg('assistant', `<h4>New session</h4>Drop a file above to begin.`); 
  document.getElementById('downloadJsonl').disabled = true;
  document.getElementById('downloadZip').disabled = true;
});

async function handleFile(file){
  addMsg('user', `<strong>Uploaded:</strong> ${file.name}`);
  const thinking = addMsg('assistant', `Parsing <b>${file.name}</b>…`);
  try{
    rawRows = await parseFile(file);
    columns = Object.keys(rawRows[0] || {});
    thinking.innerHTML = `Parsed <b>${rawRows.length.toLocaleString()}</b> rows, <b>${columns.length}</b> columns. Inferring roles for <b>${packetType}</b>…`;
    await processAndShow();
  }catch(err){
    thinking.innerHTML = `<span style="color:#b91c1c">Error:</span> ${err.message}`;
  }
}

async function processAndShow(){
  const bubble = addMsg('assistant', `Mapping columns & building packet…`);
  const map = guessMapping(columns, packetType);
  bubble.innerHTML = `
    <div><strong>Role mapping</strong></div>
    <div class="row" style="margin:8px 0">
      ${Object.entries(map).map(([k,v])=>`<span style="background:#eef2f7;border:1px solid #e3e6eb;border-radius:999px;padding:4px 10px;font-size:12px">${k}: <b>${escapeHtml(String(v||'—'))}</b></span>`).join(' ')}
    </div>
    Assembling rows…`;
  builtRows = assemble(rawRows, map, packetType);

  // Preview
  const prev = addMsg('assistant', `<strong>Preview (${Math.min(5, builtRows.length)} of ${builtRows.length.toLocaleString()})</strong>`);
  const sample = builtRows.slice(0,5);
  addCodeBlock(prev, toJSONL(sample));

  // Original head preview
  const srcPrev = addMsg('assistant', `<strong>Source sample</strong>`);
  addTable(srcPrev, rawRows.slice(0,8), columns);

  // Enable downloads
  const jsonl = toJSONL(builtRows);
  const dlJsonlBtn = document.getElementById('downloadJsonl');
  const dlZipBtn   = document.getElementById('downloadZip');
  dlJsonlBtn.disabled = false;
  dlZipBtn.disabled   = false;

  dlJsonlBtn.onclick = ()=> {
    const blob = new Blob([jsonl], {type:'application/jsonl'});
    saveAs(blob, `magenta_${packetType}_${Date.now()}.jsonl`);
  };
  dlZipBtn.onclick = async ()=> {
    const zipBlob = await makeZip(jsonl, packetType, map, builtRows.length);
    saveAs(zipBlob, `magenta_packet_${packetType}_${Date.now()}.zip`);
  };

  addMsg('assistant', `✅ Packet ready. Use the buttons in the left sidebar to download <b>JSONL</b> or a full <b>ZIP</b> bundle.`);
}
</script>
</body>
</html>


