<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Magenta — Microknots Data Packet Builder</title>

<!-- External libs (CDN) -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  :root{
    --bg:#0b0b0f;
    --card:#12121a;
    --ink:#e9e9ef;
    --muted:#b7b7c6;
    --brand1:#7c3aed; /* purple */
    --brand2:#00b3ff; /* blue */
    --brand3:#ff00cc; /* magenta */
    --ring:0 0 0 2px rgba(124,58,237,.35),0 0 35px rgba(0,179,255,.25);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background:
      radial-gradient(1200px 600px at -10% 110%, rgba(124,58,237,.25), transparent 60%),
      radial-gradient(900px 500px at 120% -10%, rgba(0,179,255,.2), transparent 50%),
      linear-gradient(180deg, #0a0a0e 0%, #0d0d14 100%);
    min-height:100vh;
  }
  header{
    display:flex; align-items:center; gap:16px;
    padding:24px 28px; position:sticky; top:0; z-index:5;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg, rgba(12,12,18,.9), rgba(12,12,18,.6));
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  header img{height:44px; width:auto; border-radius:8px; box-shadow:0 6px 30px rgba(124,58,237,.35)}
  .title{
    line-height:1.1;
  }
  .title h1{margin:0; font-weight:800; letter-spacing:.2px; font-size:24px}
  .title p{margin:2px 0 0; color:var(--muted); font-size:13px}
  .container{padding:28px; max-width:1200px; margin:0 auto}
  .grid{display:grid; grid-template-columns: 320px 1fr; gap:24px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px; padding:18px;
    box-shadow: 0 12px 40px rgba(0,0,0,.35);
  }
  .card h3{margin:0 0 10px; font-size:14px; text-transform:uppercase; letter-spacing:.14em; color:#cfcfe7}
  .sub{color:var(--muted); font-size:12px; margin-top:6px}
  label{font-size:13px; color:#d6d6ea; display:block; margin:12px 0 6px}
  input[type="text"], input[type="number"], textarea, select{
    width:100%; background:#0f0f15; color:var(--ink);
    border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:10px 12px;
    outline:none; transition:.2s border, .2s box-shadow;
  }
  input[type="text"]:focus, textarea:focus, select:focus{
    border-color: var(--brand1); box-shadow: var(--ring);
  }
  input[type="file"]{width:100%}
  .btn{
    appearance:none; border:none; cursor:pointer;
    padding:10px 14px; border-radius:12px; font-weight:700;
    color:#0b0b0f; background:linear-gradient(90deg, var(--brand1), var(--brand2) 50%, var(--brand3));
    transition:.15s transform, .15s filter; will-change:transform;
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{
    background:transparent; color:var(--ink);
    border:1px solid rgba(255,255,255,.14)
  }
  .muted{color:var(--muted)}
  .row{display:flex; gap:10px; align-items:center}
  .pill{
    display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
    font-size:12px; border:1px solid rgba(255,255,255,.12); color:#dcdcf0;
  }
  .map-grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
  table{width:100%; border-collapse:collapse; font-size:12px}
  th, td{border-bottom:1px solid rgba(255,255,255,.08); padding:8px 10px; text-align:left}
  .footer-actions{display:flex; gap:12px; justify-content:flex-end; padding-top:18px}
  .switch{display:inline-flex; align-items:center; gap:8px; font-size:12px; color:var(--muted)}
  .switch input{accent-color:var(--brand1)}
  .tag{display:inline-block; padding:2px 8px; border:1px solid rgba(255,255,255,.15); border-radius:999px; font-size:11px; margin-right:6px}
  .badge{background:rgba(124,58,237,.18); border:1px solid rgba(124,58,237,.36); color:#e7dcff}
  .hint{font-size:11px; color:#9ea0b6}
  .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent); margin:14px 0}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .danger{color:#ff6b9e}
  .ok{color:#50e3a4}
  .flex{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .kpi{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px}
  .kpi .card{padding:16px}
  .kpi h4{margin:0; font-size:12px; color:#bdbddb; text-transform:uppercase; letter-spacing:.14em}
  .kpi p{margin:6px 0 0; font-weight:800; font-size:18px}
  .tiny{font-size:10px; color:#a7a7bf}
  .notice{padding:10px 12px; background:rgba(0,179,255,.1); border:1px solid rgba(0,179,255,.25); border-radius:12px; font-size:12px}
  .footer-note{margin-top:16px; color:#9aa0b3; font-size:11px}
  .hidden{display:none}
  .shadow-disc{
    position:absolute; width:300px; height:300px; border-radius:999px; filter:blur(40px);
    background:conic-gradient(from 30deg, rgba(124,58,237,.95), rgba(0,179,255,.8), rgba(255,0,204,.9), rgba(124,58,237,.95));
    opacity:.12; pointer-events:none; mix-blend:screen;
  }
</style>
</head>
<body>
  <div class="shadow-disc" style="top:-100px; left:-120px;"></div>
  <div class="shadow-disc" style="bottom:-120px; right:-100px; width:380px; height:380px;"></div>

  <header>
    <img src="microknots-logo.png" alt="microknots logo" onerror="this.style.display='none'">
    <div class="title">
      <h1>Magenta — Data Packet Builder</h1>
      <p>Convert raw sheets into LLM-ready JSONL with labeling, PII scrubbing, and normalization — themed by Microknots.</p>
    </div>
    <div style="margin-left:auto" class="flex">
      <span class="pill"><span>Theme</span><span class="mono">microknots</span></span>
      <span class="pill badge">v1.0</span>
    </div>
  </header>

  <main class="container">
    <div class="kpi">
      <div class="card">
        <h4>Rows</h4><p id="kpi-rows">0</p><div class="tiny" id="kpi-cols">—</div>
      </div>
      <div class="card">
        <h4>Packet Type</h4><p id="kpi-type">—</p><div class="tiny" id="kpi-mapped">0 mapped fields</div>
      </div>
      <div class="card">
        <h4>Labels</h4><p id="kpi-labels">0</p><div class="tiny">class balance chart below</div>
      </div>
      <div class="card">
        <h4>Quality</h4><p id="kpi-quality" class="ok">Ready</p><div class="tiny">PII scrub & dedupe optional</div>
      </div>
    </div>

    <div class="grid" style="margin-top:22px">
      <!-- LEFT: Controls -->
      <section class="card">
        <h3>1 • Load Data</h3>
        <label>Upload file (.csv, .xlsx, .json)</label>
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json" />
        <div class="sub">We process locally in your browser. Nothing leaves your machine.</div>

        <div class="hr"></div>

        <h3>2 • Packet Template</h3>
        <label>Choose packet type</label>
        <select id="packetType">
          <option value="classification">Classification (text + label)</option>
          <option value="chat">Chat/Instruction (input → expected_output)</option>
          <option value="rag">RAG Chunk (content + source metadata)</option>
        </select>
        <div id="ragOpts" class="notice hidden">
          <div class="row">
            <label style="margin:0">Chunk size (chars)</label>
            <input type="number" id="chunkSize" value="900" min="200" max="4000" style="width:110px">
            <label style="margin:0">Overlap</label>
            <input type="number" id="chunkOverlap" value="120" min="0" max="1000" style="width:110px">
          </div>
          <div class="tiny">RAG mode will split long text into overlapping chunks.</div>
        </div>

        <div class="hr"></div>

        <h3>3 • Column Mapping</h3>
        <div id="mapping" class="map-grid"></div>
        <div class="sub">We auto-suggest roles after loading. You can change any dropdown.</div>

        <div class="hr"></div>

        <h3>4 • Quality & Privacy</h3>
        <div class="switch"><input type="checkbox" id="lowercase"> <label for="lowercase" style="margin:0">Lowercase text</label></div>
        <div class="switch"><input type="checkbox" id="collapseWS" checked> <label for="collapseWS" style="margin:0">Collapse whitespace & trim</label></div>
        <div class="switch"><input type="checkbox" id="stripHtml" checked> <label for="stripHtml" style="margin:0">Strip HTML tags</label></div>
        <div class="switch"><input type="checkbox" id="dedupe"> <label for="dedupe" style="margin:0">Deduplicate by text</label></div>
        <div class="switch"><input type="checkbox" id="scrubPII" checked> <label for="scrubPII" style="margin:0">Scrub PII (emails, phones, SSN, CC#)</label></div>

        <div class="hr"></div>

        <h3>5 • Labeling Rules (optional)</h3>
        <div class="sub">Auto-annotate by keywords/regex. Example regex: <span class="mono">/refund|chargeback/i</span></div>
        <div class="row">
          <input type="text" id="ruleLabel" placeholder="Label name (e.g., Support)" />
        </div>
        <div class="row">
          <input type="text" id="ruleQuery" placeholder="Keywords (comma) or /regex/i" />
          <button class="btn secondary" id="addRule">Add Rule</button>
        </div>
        <div id="rules" class="flex" style="margin-top:6px"></div>
        <div class="sub">Rules only apply if your label column is not already mapped.</div>

        <div class="hr"></div>

        <h3>Export</h3>
        <div class="footer-actions">
          <button class="btn secondary" id="btnPreview">Preview 30 rows</button>
          <button class="btn" id="btnGenerate">Generate Packet (JSONL + ZIP)</button>
        </div>
        <div class="footer-note">Output includes: <span class="tag">data.jsonl</span> <span class="tag">manifest.json</span> <span class="tag">schema.json</span> <span class="tag">README.md</span></div>
      </section>

      <!-- RIGHT: Preview & Charts -->
      <section class="card">
        <h3>Dataset Preview</h3>
        <div id="preview">Load a file to see rows…</div>
        <div class="hr"></div>
        <h3>Label Balance</h3>
        <canvas id="lblChart" height="160"></canvas>
        <div class="hr"></div>
        <h3>Packet JSONL Sample</h3>
        <pre id="jsonlSample" class="mono" style="white-space:pre-wrap; font-size:12px; background:#0f0f15; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08)">—</pre>
      </section>
    </div>

    <div class="footer-note">© Microknots • Magenta packetizer runs entirely in-browser.</div>
  </main>

<script>
/* ======= State ======= */
let rawRows = [];       // array of objects
let columns = [];       // column names
let rules = [];         // [{label, type:'keywords'|'regex', query:RegExp|string[]}]
let mapping = {};       // role -> column
let packetType = 'classification';

const els = {
  file: document.getElementById('fileInput'),
  map:  document.getElementById('mapping'),
  pkt:  document.getElementById('packetType'),
  ragOpts: document.getElementById('ragOpts'),
  chunkSize: document.getElementById('chunkSize'),
  chunkOverlap: document.getElementById('chunkOverlap'),
  preview: document.getElementById('preview'),
  kRows: document.getElementById('kpi-rows'),
  kCols: document.getElementById('kpi-cols'),
  kType: document.getElementById('kpi-type'),
  kMap: document.getElementById('kpi-mapped'),
  kLabels: document.getElementById('kpi-labels'),
  kQuality: document.getElementById('kpi-quality'),
  lblChart: document.getElementById('lblChart'),
  jsonlSample: document.getElementById('jsonlSample'),
  btnPreview: document.getElementById('btnPreview'),
  btnGen: document.getElementById('btnGenerate'),
  ruleLabel: document.getElementById('ruleLabel'),
  ruleQuery: document.getElementById('ruleQuery'),
  addRule: document.getElementById('addRule'),
  rules: document.getElementById('rules'),
  toggles:{
    lowercase: document.getElementById('lowercase'),
    collapseWS: document.getElementById('collapseWS'),
    stripHtml: document.getElementById('stripHtml'),
    dedupe: document.getElementById('dedupe'),
    scrubPII: document.getElementById('scrubPII'),
  }
};

/* ======= Helpers ======= */
const isRegexLiteral = (s)=> /^\/.*\/[a-z]*$/.test(s.trim());
const toRegex = (s)=> {
  const m = s.trim().match(/^\/(.*)\/([a-z]*)$/);
  return new RegExp(m[1], m[2]||'');
};
const stripHTML = (s)=> s.replace(/<[^>]+>/g,' ');
const collapseWS = (s)=> s.replace(/\s+/g,' ').trim();
const lower = (s)=> s.toLowerCase();
const scrubPII = (s)=>{
  return s
    // emails
    .replace(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi,'<EMAIL>')
    // phones
    .replace(/(?:\+?\d{1,3}[-.\s]?)?(?:\(?\d{2,4}\)?[-.\s]?){2,3}\d{3,4}/g, (m)=> m.replace(/\d/g,'#'))
    // SSN
    .replace(/\b\d{3}-?\d{2}-?\d{4}\b/g,'<SSN>')
    // credit cards (simplified)
    .replace(/\b(?:\d[ -]*?){13,19}\b/g,'<CARD>');
};
const applyQuality = (s)=>{
  if(typeof s !== 'string') return s;
  if(els.toggles.stripHtml.checked) s = stripHTML(s);
  if(els.toggles.collapseWS.checked) s = collapseWS(s);
  if(els.toggles.lowercase.checked) s = lower(s);
  if(els.toggles.scrubPII.checked) s = scrubPII(s);
  return s;
};
const uniqBy = (arr, keyFn)=> {
  const seen = new Set(); return arr.filter(r=>{const k=keyFn(r); if(seen.has(k)) return false; seen.add(k); return true;});
};
const guessRoles = ()=>{
  const lc = columns.map(c=>[c, c.toLowerCase()]);
  const find = (words)=> lc.find(([c,l])=>words.some(w=> l.includes(w)))?.[0];
  const roles = needRolesFor(packetType);
  const m = {};
  if(roles.includes('text')) m.text = find(['text','message','content','review','body','comment','description']) || columns[0];
  if(roles.includes('label')) m.label = find(['label','class','category','intent','tag']);
  if(roles.includes('input')) m.input = find(['input','question','prompt','query','source']) || columns[0];
  if(roles.includes('output')) m.output = find(['output','answer','response','completion','target']);
  if(roles.includes('source')) m.source = find(['source','url','path','doc','file']);
  if(roles.includes('id')) m.id = find(['id','uuid','guid','key']);
  mapping = m;
};
const needRolesFor = (type)=>{
  if(type==='classification') return ['text','label','id'];
  if(type==='chat') return ['input','output','id'];
  if(type==='rag') return ['text','source','id'];
  return [];
};
const renderMapping = ()=>{
  const roles = needRolesFor(packetType);
  els.map.innerHTML = roles.map(role=>{
    const sel = `<select data-role="${role}">` + ['—', ...columns].map(c=>`<option ${mapping[role]===c?'selected':''}>${c||'—'}</option>`).join('') + `</select>`;
    const hint = role==='text' ? 'text field' :
                 role==='label'? 'class/category' :
                 role==='input'? 'prompt/question' :
                 role==='output'? 'expected answer' :
                 role==='source'? 'url/filename' : 'stable unique id';
    return `<div>
      <label>${role.toUpperCase()} <span class="hint">(${hint})</span></label>
      ${sel}
    </div>`;
  }).join('');
  els.map.querySelectorAll('select').forEach(s=>{
    s.addEventListener('change', e=>{ const r=e.target.dataset.role; mapping[r] = e.target.value==='—'?null:e.target.value; refreshKPIs(); });
  });
};
const refreshKPIs = ()=>{
  els.kRows.textContent = rawRows.length.toLocaleString();
  els.kCols.textContent = columns.length ? `${columns.length} columns` : '—';
  els.kType.textContent = packetType.toUpperCase();
  els.kMap.textContent = Object.values(mapping).filter(Boolean).length + '

